# Shuffle Button Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add an artful Shuffle button to the editor that randomises image order and assigns orientation-aware sizes from a weighted palette, using the existing `pinAllItems()` engine for gap-free placement.

**Architecture:** Single `shuffleLayout()` function added to gallery9.js. Reuses `pushUndo`, `isSpacer`, `clearSizeClasses`, `applySizeClass`, `pinAllItems`, `autoSave`. Button added to the banner HTML string and wired in `toggleEditor`.

**Tech Stack:** Vanilla JS, no new dependencies.

---

## Task 1: Add `shuffleLayout()` function to gallery9.js

**Files:**
- Modify: `gallery9.js`

**Context:**

The Reset handler (around line 2840) is the exact template. `shuffleLayout` follows the same pattern but:
- Uses Fisher-Yates shuffle instead of keeping existing order
- Assigns sizes from a weighted palette based on portrait/landscape orientation
- Applies a no-repeat-adjacent rule (re-roll once if same size as previous)

The function should be placed immediately after the Reset handler's closing `});` and before the next `// ──` section comment.

Find the reset handler end by looking for `autoSave();` followed by `});` followed by a blank line and the next section comment.

**Step 1: Read the file around line 2860-2880 to find the exact insertion point**

Look for the pattern:
```js
    autoSave();
  });
```
...followed by a blank line and the next `// ──` comment after the reset handler.

**Step 2: Insert the `shuffleLayout` function**

Insert this complete function immediately after the reset handler's closing `});`:

```js

  // ── Shuffle Layout ──

  function shuffleLayout() {
    pushUndo();

    var gallery = getGallery();
    var items = getGalleryItems();

    // Remove all spacers — clean slate
    items.filter(isSpacer).forEach(function (s) { s.remove(); });

    // Re-read after spacer removal
    var imgItems = getGalleryItems();

    // Fisher-Yates shuffle
    for (var i = imgItems.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = imgItems[i];
      imgItems[i] = imgItems[j];
      imgItems[j] = tmp;
    }

    // Weighted size palettes — portrait vs landscape
    // Flat arrays: entry count = weight, pick by random index
    var LANDSCAPE_PALETTE = [
      "6x4","6x4","6x4","6x4","6x4","6x4","6x4", // weight 7 — workhorse medium
      "9x4","9x4","9x4","9x4",                    // weight 4 — wide medium
      "9x6","9x6",                                 // weight 2 — wide tall
      "12x4","12x4","12x4",                        // weight 3 — hero landscape
      "12x6","12x6",                               // weight 2 — large hero
      "4x4","4x4"                                  // weight 2 — square accent
    ];
    var PORTRAIT_PALETTE = [
      "4x6","4x6","4x6","4x6","4x6","4x6","4x6","4x6", // weight 8 — standard portrait
      "4x8","4x8","4x8",                                // weight 3 — tall portrait
      "6x8","6x8","6x8","6x8",                          // weight 4 — wide portrait
      "6x9","6x9",                                      // weight 2 — statement portrait
      "6x6","6x6","6x6"                                 // weight 3 — square accent
    ];

    var prevSize = null;

    imgItems.forEach(function (item) {
      var img = item.querySelector("img");
      var isPortrait = img && img.naturalHeight > img.naturalWidth * 1.1;
      var palette = isPortrait ? PORTRAIT_PALETTE : LANDSCAPE_PALETTE;

      // Pick a random size
      var size = palette[Math.floor(Math.random() * palette.length)];

      // No-repeat-adjacent: re-roll once if same size as previous item
      if (size === prevSize) {
        size = palette[Math.floor(Math.random() * palette.length)];
      }
      prevSize = size;

      // Apply size and clear any pinned position
      clearSizeClasses(item);
      applySizeClass(item, size);
      item.style.gridColumn = "";
      item.style.gridRow    = "";

      // Re-append in shuffled order so DOM order matches intended layout order
      gallery.appendChild(item);
    });

    pinAllItems();
    refreshSlots();
    autoSave();
  }
```

**Step 3: Verify insertion**

Read the area around the insertion point and confirm:
- `shuffleLayout` function is present and complete
- No existing code was disturbed
- The function ends with `  }` followed by a blank line then the next section comment

**Step 4: Commit**

```bash
cd /Users/dustintchambers/Documents/dev/lot43imagegallery
git add gallery9.js
git commit -m "feat: add shuffleLayout() with weighted orientation-aware size palette"
```

---

## Task 2: Add Shuffle button to banner HTML and wire event listener

**Files:**
- Modify: `gallery9.js`

**Context:**

The banner HTML string is built inside `toggleEditor` (search for `editor-reset`). The current action buttons line is:

```js
'<button id="editor-done">Done</button>' +
'<button id="editor-edit-image" disabled>\u270f Edit Image</button>' +
(canEdit ? '<button id="editor-publish">Publish</button>' : '') +
'<button id="editor-reset">Reset</button>' +
```

The event listener wiring for the Reset button is nearby (search for `editor-reset` addEventListener). The Shuffle listener should be added immediately before the Reset listener block.

**Step 1: Add Shuffle button to the banner HTML string**

Find:
```js
            (canEdit ? '<button id="editor-publish">Publish</button>' : '') +
            '<button id="editor-reset">Reset</button>' +
```

Replace with:
```js
            (canEdit ? '<button id="editor-publish">Publish</button>' : '') +
            '<button id="editor-shuffle">Shuffle</button>' +
            '<button id="editor-reset">Reset</button>' +
```

**Step 2: Add Shuffle event listener**

Find the reset button's addEventListener block:
```js
      document
        .getElementById("editor-reset")
        .addEventListener("click", function () {
```

Insert this immediately before it:
```js
      document
        .getElementById("editor-shuffle")
        .addEventListener("click", function () {
          shuffleLayout();
        });

```

**Step 3: Verify**

- Grep for `editor-shuffle` — should appear exactly twice: once in the HTML string, once in addEventListener
- Grep for `shuffleLayout` — should appear exactly twice: function definition + the button click handler

**Step 4: Syntax check**

```bash
node --check /Users/dustintchambers/Documents/dev/lot43imagegallery/gallery9.js
```

Expected: exits 0, no output.

**Step 5: Commit**

```bash
cd /Users/dustintchambers/Documents/dev/lot43imagegallery
git add gallery9.js
git commit -m "feat: add Shuffle button to editor banner"
```

---

## Task 3: Bump version and push

**Files:**
- Modify: `gallery9.html`

**Step 1: Bump JS version**

In `gallery9.html`, find:
```html
  <script src="gallery9.js?v=10"></script>
```

Change to:
```html
  <script src="gallery9.js?v=11"></script>
```

**Step 2: Final syntax check**

```bash
node --check /Users/dustintchambers/Documents/dev/lot43imagegallery/gallery9.js && echo "PASS"
```

**Step 3: Commit and push**

```bash
cd /Users/dustintchambers/Documents/dev/lot43imagegallery
git add gallery9.html
git commit -m "chore: bump to js?v=11 after shuffle feature"
git push origin main
git log --oneline -5
```

---

## Success Criteria

- [ ] Shuffle button visible in editor banner between Publish and Reset
- [ ] Clicking Shuffle removes spacers, randomises order, assigns varied sizes
- [ ] Portrait images get portrait sizes; landscape get landscape sizes
- [ ] No two adjacent images have the same size (after re-roll)
- [ ] ⌘Z reverts the shuffle
- [ ] `node --check` passes
- [ ] Pushed to GitHub Pages
